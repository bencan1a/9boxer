name: Documentation Auto-Update

on:
  pull_request:
    paths:
      # Trigger on frontend component changes
      - 'frontend/src/components/**'
      - 'frontend/src/pages/**'
      - 'frontend/src/theme/**'
      # Also trigger on metadata changes (to test the system)
      - '.github/component-screenshot-map.json'
  workflow_dispatch:
    inputs:
      screenshots:
        description: 'Comma-separated list of screenshots to regenerate (leave empty for all)'
        required: false
        type: string
      base_branch:
        description: 'Base branch to compare against (defaults to main)'
        required: false
        type: string
        default: 'main'

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-doc-impact:
    name: Detect Documentation Impact
    runs-on: ubuntu-latest

    outputs:
      screenshots_affected: ${{ steps.analyze.outputs.screenshots_affected }}
      changed_components: ${{ steps.analyze.outputs.changed_components }}
      affected_screenshots: ${{ steps.analyze.outputs.affected_screenshots }}
      screenshot_count: ${{ steps.analyze.outputs.screenshot_count }}
      component_count: ${{ steps.analyze.outputs.component_count }}
      theme_changed: ${{ steps.analyze.outputs.theme_changed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Analyze Changed Components
        id: analyze
        run: |
          echo "::group::Analyzing component changes"
          node .github/scripts/detect-doc-impact.js --base=${{ github.event_name == 'workflow_dispatch' && inputs.base_branch || github.base_ref }}
          echo "::endgroup::"

      - name: Upload Analysis Results
        if: steps.analyze.outputs.screenshots_affected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: affected-screenshots
          path: .affected-screenshots.json
          retention-days: 7
          include-hidden-files: true

      - name: Comment on PR - No Impact
        if: steps.analyze.outputs.screenshots_affected != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // Remove old bot comments
            for (const comment of comments) {
              if (comment.user.type === 'Bot' && comment.body.includes('ğŸ“Š Documentation Impact Analysis')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
              }
            }

            // Post new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## ğŸ“Š Documentation Impact Analysis\n\n' +
                    'âœ… **No documentation screenshots affected by these changes.**\n\n' +
                    'The changed files do not impact any components with documentation screenshots.'
            });

      - name: Comment on PR - Impact Detected
        if: steps.analyze.outputs.screenshots_affected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // Remove old bot comments
            for (const comment of comments) {
              if (comment.user.type === 'Bot' && comment.body.includes('ğŸ“Š Documentation Impact Analysis')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
              }
            }

            const screenshotCount = '${{ steps.analyze.outputs.screenshot_count }}';
            const componentCount = '${{ steps.analyze.outputs.component_count }}';
            const changedComponents = '${{ steps.analyze.outputs.changed_components }}';
            const affectedScreenshots = '${{ steps.analyze.outputs.affected_screenshots }}';
            const themeChanged = '${{ steps.analyze.outputs.theme_changed }}' === 'true';

            const componentsList = changedComponents.split(', ').map(c => '- `' + c + '`').join('\n');
            const screenshotsList = affectedScreenshots.split(', ').map(s => '- `' + s + '`').join('\n');
            const themeWarning = themeChanged ? '- **âš ï¸ Theme Changed:** This may affect more screenshots than detected\n' : '';

            const body = '## ğŸ“Š Documentation Impact Analysis\n\n' +
                    'âš ï¸ **This PR affects ' + screenshotCount + ' documentation screenshot(s)**\n\n' +
                    '### ğŸ“‹ Summary\n' +
                    '- **Components Changed:** ' + componentCount + '\n' +
                    '- **Screenshots Affected:** ' + screenshotCount + '\n' +
                    themeWarning +
                    '\n### ğŸ§© Changed Components\n' +
                    componentsList + '\n\n' +
                    '### ğŸ“¸ Affected Screenshots\n' +
                    screenshotsList + '\n\n' +
                    '### ğŸ”„ Next Steps\n\n' +
                    'The documentation auto-update workflow will:\n' +
                    '1. Regenerate the affected screenshots\n' +
                    '2. Create a documentation PR for review\n' +
                    '3. Link the documentation PR to this PR\n\n' +
                    '---\n' +
                    '*ğŸ¤– Auto-generated by Documentation Auto-Update workflow*';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  regenerate-screenshots:
    name: Regenerate Affected Screenshots
    needs: detect-doc-impact
    if: needs.detect-doc-impact.outputs.screenshots_affected == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: |
          cd frontend
          npx playwright install --with-deps chromium

      - name: Download Analysis Results
        uses: actions/download-artifact@v4
        with:
          name: affected-screenshots
          path: .

      - name: Start Backend (for screenshot generation)
        run: |
          # Start backend in background (dependencies installed system-wide by setup-python-env)
          # Start uvicorn using --app-dir to avoid fragile directory changes
          uvicorn --app-dir backend/src ninebox.main:app --host 127.0.0.1 --port 38000 > backend.log 2>&1 &
          BACKEND_PID=$!
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV

          # Wait for backend with better error handling
          echo "Waiting for backend to start..."
          if ! timeout 30 bash -c 'until curl -sf http://127.0.0.1:38000/health >/dev/null 2>&1; do echo "...waiting"; sleep 2; done'; then
            echo "âŒ Backend failed to start within 30 seconds"
            if [ -f backend.log ]; then
              echo "=== Backend Logs ==="
              cat backend.log
            fi
            exit 1
          fi
          echo "âœ… Backend started successfully"

      - name: Regenerate Affected Screenshots
        id: regenerate
        run: |
          cd frontend
          npm run screenshots:generate:affected

      - name: Run Visual Regression Tests
        id: visual-regression
        continue-on-error: true
        run: |
          cd frontend
          # Run visual regression tests on regenerated screenshots
          # First run will create baselines, subsequent runs will compare
          npm run test:docs-visual -- --reporter=json --output-file=visual-regression-results.json || true

          # Check if there are visual differences
          if [ -f visual-regression-results.json ]; then
            # Extract test results
            TESTS_PASSED=$(jq '.stats.expected' visual-regression-results.json 2>/dev/null || echo "0")
            TESTS_FAILED=$(jq '.stats.unexpected' visual-regression-results.json 2>/dev/null || echo "0")

            echo "visual_tests_passed=$TESTS_PASSED" >> $GITHUB_OUTPUT
            echo "visual_tests_failed=$TESTS_FAILED" >> $GITHUB_OUTPUT

            if [ "$TESTS_FAILED" -gt 0 ]; then
              echo "âš ï¸ Visual regression tests detected differences"
              echo "visual_regressions_detected=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… Visual regression tests passed"
              echo "visual_regressions_detected=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ Visual regression results not found"
            echo "visual_regressions_detected=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Generate Visual Diff Report
        if: always()
        run: |
          # Generate HTML visual diff report
          node .github/scripts/generate-visual-diff-report.js --json

          # Check if report was generated
          if [ -f frontend/visual-diff-report.html ]; then
            echo "âœ… Visual diff report generated"
            echo "visual_diff_report_generated=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Visual diff report not generated (no diffs found or error)"
            echo "visual_diff_report_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Visual Regression Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-report
          path: |
            frontend/playwright-report/
            frontend/test-results/
            frontend/visual-regression-results.json
            frontend/visual-diff-report.html
            frontend/visual-diff-report.json
          retention-days: 30

      - name: Stop Backend
        if: always()
        run: |
          if [ -n "$BACKEND_PID" ]; then
            kill $BACKEND_PID || true
          fi
          # Capture logs for debugging
          if [ -f backend.log ]; then
            echo "=== Backend Logs ==="
            cat backend.log
          fi

      - name: Create Documentation PR
        if: success()
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs: auto-update screenshots for PR #${{ github.event.number }}

            ğŸ¤– Generated with Claude Code
          branch: docs/auto-update-pr-${{ github.event.number }}
          delete-branch: true
          title: "docs: Auto-update screenshots for PR #${{ github.event.number }}"
          body: |
            ## ğŸ“¸ Automated Documentation Update

            This PR was automatically created because PR #${{ github.event.number }} modified components that affect user documentation.

            ### ğŸ“Š Impact Summary
            - **Changed Components:** ${{ needs.detect-doc-impact.outputs.component_count }}
            - **Screenshots Regenerated:** ${{ needs.detect-doc-impact.outputs.screenshot_count }}

            ### ğŸ§© Changed Components
            ${{ needs.detect-doc-impact.outputs.changed_components }}

            ### ğŸ“¸ Affected Screenshots
            ${{ needs.detect-doc-impact.outputs.affected_screenshots }}

            ### ğŸ‘ï¸ Visual Regression Status
            ${{ steps.visual-regression.outputs.visual_regressions_detected == 'true' && 'âš ï¸ **Visual differences detected** - Review the visual regression report in the workflow artifacts' || steps.visual-regression.outputs.visual_regressions_detected == 'false' && 'âœ… **No visual regressions detected**' || 'â“ **Visual regression status unknown**' }}

            - Tests Passed: ${{ steps.visual-regression.outputs.visual_tests_passed || 'N/A' }}
            - Tests Failed: ${{ steps.visual-regression.outputs.visual_tests_failed || 'N/A' }}

            ${{ steps.visual-regression.outputs.visual_regressions_detected == 'true' && '**Note:** Visual differences may be intentional if the component UI was deliberately changed. Review the diff report in the workflow artifacts.' || '' }}

            ### ğŸ“Š Visual Diff Report
            ${{ steps.visual-regression.outputs.visual_diff_report_generated == 'true' && 'âœ… **Visual diff report available** - Download the `visual-regression-report` artifact from the workflow run to view side-by-side comparisons of screenshot changes.' || 'âœ… No visual diff report needed - all screenshots match baselines.' }}

            ### âœ… Action Required
            - [ ] Review visual changes in regenerated screenshots
            - [ ] Verify screenshots accurately represent current UX
            - [ ] Update user guide text if component behavior changed
            - [ ] Merge this PR after the original PR #${{ github.event.number }} is merged

            ### ğŸ”— Related PR
            - Original PR: #${{ github.event.number }}
            - Triggered by: @${{ github.event.pull_request.user.login }}

            ---
            ğŸ¤– Auto-generated by Documentation Auto-Update workflow
          labels: |
            documentation
            automated
            screenshots
          assignees: ${{ github.event.pull_request.user.login }}

      - name: Upload Screenshot Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: regenerated-screenshots
          path: resources/user-guide/docs/images/screenshots/
          retention-days: 30
