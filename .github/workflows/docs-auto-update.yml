name: Documentation Auto-Update

on:
  pull_request:
    paths:
      # Trigger on frontend component changes
      - 'frontend/src/components/**'
      - 'frontend/src/pages/**'
      - 'frontend/src/theme/**'
      # Also trigger on metadata changes (to test the system)
      - '.github/component-screenshot-map.json'
  workflow_dispatch:
    inputs:
      screenshots:
        description: 'Comma-separated list of screenshots to regenerate (leave empty for all)'
        required: false
        type: string
      base_branch:
        description: 'Base branch to compare against (defaults to main)'
        required: false
        type: string
        default: 'main'

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-doc-impact:
    name: Detect Documentation Impact
    runs-on: ubuntu-latest

    outputs:
      screenshots_affected: ${{ steps.analyze.outputs.screenshots_affected }}
      changed_components: ${{ steps.analyze.outputs.changed_components }}
      affected_screenshots: ${{ steps.analyze.outputs.affected_screenshots }}
      screenshot_count: ${{ steps.analyze.outputs.screenshot_count }}
      component_count: ${{ steps.analyze.outputs.component_count }}
      theme_changed: ${{ steps.analyze.outputs.theme_changed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Analyze Changed Components
        id: analyze
        run: |
          echo "::group::Analyzing component changes"
          node .github/scripts/detect-doc-impact.js --base=${{ github.event_name == 'workflow_dispatch' && inputs.base_branch || github.base_ref }}
          echo "::endgroup::"

      - name: Upload Analysis Results
        if: steps.analyze.outputs.screenshots_affected == 'true' && hashFiles('.affected-screenshots.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: affected-screenshots
          path: .affected-screenshots.json
          retention-days: 7
          include-hidden-files: true

      - name: Comment on PR - No Impact
        if: steps.analyze.outputs.screenshots_affected != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // Remove old bot comments
            for (const comment of comments) {
              if (comment.user.type === 'Bot' && comment.body.includes('ğŸ“Š Documentation Impact Analysis')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
              }
            }

            // Post new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '## ğŸ“Š Documentation Impact Analysis\n\n' +
                    'âœ… **No documentation screenshots affected by these changes.**\n\n' +
                    'The changed files do not impact any components with documentation screenshots.'
            });

      - name: Comment on PR - Impact Detected
        if: steps.analyze.outputs.screenshots_affected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // Remove old bot comments
            for (const comment of comments) {
              if (comment.user.type === 'Bot' && comment.body.includes('ğŸ“Š Documentation Impact Analysis')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
              }
            }

            const screenshotCount = '${{ steps.analyze.outputs.screenshot_count }}';
            const componentCount = '${{ steps.analyze.outputs.component_count }}';
            const changedComponents = '${{ steps.analyze.outputs.changed_components }}';
            const affectedScreenshots = '${{ steps.analyze.outputs.affected_screenshots }}';
            const themeChanged = '${{ steps.analyze.outputs.theme_changed }}' === 'true';

            const componentsList = changedComponents.split(', ').map(c => '- `' + c + '`').join('\n');
            const screenshotsList = affectedScreenshots.split(', ').map(s => '- `' + s + '`').join('\n');
            const themeWarning = themeChanged ? '- **âš ï¸ Theme Changed:** This may affect more screenshots than detected\n' : '';

            const body = '## ğŸ“Š Documentation Impact Analysis\n\n' +
                    'âš ï¸ **This PR affects ' + screenshotCount + ' documentation screenshot(s)**\n\n' +
                    '### ğŸ“‹ Summary\n' +
                    '- **Components Changed:** ' + componentCount + '\n' +
                    '- **Screenshots Affected:** ' + screenshotCount + '\n' +
                    themeWarning +
                    '\n### ğŸ§© Changed Components\n' +
                    componentsList + '\n\n' +
                    '### ğŸ“¸ Affected Screenshots\n' +
                    screenshotsList + '\n\n' +
                    '### ğŸ”„ Next Steps\n\n' +
                    'The documentation auto-update workflow will:\n' +
                    '1. Regenerate the affected screenshots\n' +
                    '2. Commit the updated screenshots directly to this PR\n' +
                    '3. Post a comment when the screenshots are updated\n\n' +
                    '---\n' +
                    '*ğŸ¤– Auto-generated by Documentation Auto-Update workflow*';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  regenerate-screenshots:
    name: Regenerate Affected Screenshots
    needs: detect-doc-impact
    if: needs.detect-doc-impact.outputs.screenshots_affected == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          repository: ${{ github.event.pull_request.head.repo.full_name }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python Environment
        uses: ./.github/actions/setup-python-env

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci --legacy-peer-deps

      - name: Install Playwright browsers
        run: |
          cd frontend
          npx playwright install --with-deps chromium

      - name: Download Analysis Results
        uses: actions/download-artifact@v4
        with:
          name: affected-screenshots
          path: .

      - name: Start Backend (for screenshot generation)
        run: |
          # Start backend in background (dependencies installed system-wide by setup-python-env)
          # Start uvicorn using --app-dir to avoid fragile directory changes
          uvicorn --app-dir backend/src ninebox.main:app --host 127.0.0.1 --port 38000 > backend.log 2>&1 &
          BACKEND_PID=$!
          echo "BACKEND_PID=$BACKEND_PID" >> $GITHUB_ENV

          # Wait for backend with exponential backoff (max 60s)
          echo "Waiting for backend to start..."
          MAX_ATTEMPTS=10
          ATTEMPT=1
          DELAY=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            if curl -sf http://127.0.0.1:38000/health >/dev/null 2>&1; then
              echo "âœ… Backend started successfully after $ATTEMPT attempt(s)"
              exit 0
            fi
            echo "...attempt $ATTEMPT failed, waiting ${DELAY}s"
            sleep $DELAY
            # Exponential backoff: 1, 2, 4, 8, 8, 8... (capped at 8s)
            DELAY=$((DELAY * 2))
            if [ $DELAY -gt 8 ]; then
              DELAY=8
            fi
            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "âŒ Backend failed to start within 60 seconds"
          if [ -f backend.log ]; then
            echo "=== Backend Logs ==="
            cat backend.log
          fi
          exit 1

      - name: Regenerate Affected Screenshots
        id: regenerate
        run: |
          cd frontend
          npm run screenshots:generate:affected

      - name: Run Visual Regression Tests
        id: visual-regression
        continue-on-error: true
        run: |
          cd frontend
          # Run visual regression tests on regenerated screenshots
          # First run will create baselines, subsequent runs will compare
          npm run test:docs-visual -- --reporter=json --output-file=visual-regression-results.json || true

          # Check if there are visual differences with defensive parsing
          if [ -f visual-regression-results.json ]; then
            # Validate JSON before parsing
            if jq empty visual-regression-results.json 2>/dev/null; then
              # Extract test results with defensive defaults
              TESTS_PASSED=$(jq '.stats.expected // 0' visual-regression-results.json 2>/dev/null || echo "0")
              TESTS_FAILED=$(jq '.stats.unexpected // 0' visual-regression-results.json 2>/dev/null || echo "0")

              echo "visual_tests_passed=$TESTS_PASSED" >> $GITHUB_OUTPUT
              echo "visual_tests_failed=$TESTS_FAILED" >> $GITHUB_OUTPUT

              if [ "$TESTS_FAILED" -gt 0 ]; then
                echo "âš ï¸ Visual regression tests detected differences"
                echo "visual_regressions_detected=true" >> $GITHUB_OUTPUT
              else
                echo "âœ… Visual regression tests passed"
                echo "visual_regressions_detected=false" >> $GITHUB_OUTPUT
              fi
            else
              echo "âš ï¸ Visual regression results file is not valid JSON"
              echo "visual_tests_passed=0" >> $GITHUB_OUTPUT
              echo "visual_tests_failed=0" >> $GITHUB_OUTPUT
              echo "visual_regressions_detected=unknown" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ Visual regression results not found"
            echo "visual_tests_passed=0" >> $GITHUB_OUTPUT
            echo "visual_tests_failed=0" >> $GITHUB_OUTPUT
            echo "visual_regressions_detected=unknown" >> $GITHUB_OUTPUT
          fi

      - name: Generate Visual Diff Report
        if: always()
        run: |
          # Generate HTML visual diff report
          node .github/scripts/generate-visual-diff-report.js --json

          # Check if report was generated
          if [ -f frontend/visual-diff-report.html ]; then
            echo "âœ… Visual diff report generated"
            echo "visual_diff_report_generated=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Visual diff report not generated (no diffs found or error)"
            echo "visual_diff_report_generated=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Visual Regression Report
        if: always() && (hashFiles('frontend/playwright-report/**') != '' || hashFiles('frontend/test-results/**') != '' || hashFiles('frontend/visual-regression-results.json') != '')
        uses: actions/upload-artifact@v4
        with:
          name: visual-regression-report
          path: |
            frontend/playwright-report/
            frontend/test-results/
            frontend/visual-regression-results.json
            frontend/visual-diff-report.html
            frontend/visual-diff-report.json
          retention-days: 30

      - name: Stop Backend
        if: always()
        run: |
          if [ -n "$BACKEND_PID" ]; then
            kill $BACKEND_PID || true
          fi
          # Capture logs for debugging
          if [ -f backend.log ]; then
            echo "=== Backend Logs ==="
            cat backend.log
          fi

      - name: Commit and push screenshot updates
        if: success()
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes to commit
          if [[ -n $(git status --porcelain resources/user-guide/docs/images/screenshots/) ]]; then
            git add resources/user-guide/docs/images/screenshots/
            git commit -m "docs: auto-update screenshots for affected components

            Updated ${{ needs.detect-doc-impact.outputs.screenshot_count }} screenshot(s) affected by component changes:
            ${{ needs.detect-doc-impact.outputs.changed_components }}

            ğŸ¤– Generated with Claude Code"

            git push
            echo "screenshots_committed=true" >> $GITHUB_OUTPUT
          else
            echo "No screenshot changes to commit"
            echo "screenshots_committed=false" >> $GITHUB_OUTPUT
          fi
        id: commit

      - name: Comment on PR with update status
        if: steps.commit.outputs.screenshots_committed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // Remove old screenshot update comments
            for (const comment of comments) {
              if (comment.user.type === 'Bot' && comment.body.includes('ğŸ“¸ Screenshots Auto-Updated')) {
                await github.rest.issues.deleteComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: comment.id,
                });
              }
            }

            const screenshotCount = '${{ needs.detect-doc-impact.outputs.screenshot_count }}';
            const componentCount = '${{ needs.detect-doc-impact.outputs.component_count }}';
            const changedComponents = '${{ needs.detect-doc-impact.outputs.changed_components }}';
            const affectedScreenshots = '${{ needs.detect-doc-impact.outputs.affected_screenshots }}';
            const visualRegressionsDetected = '${{ steps.visual-regression.outputs.visual_regressions_detected }}';
            const visualTestsPassed = '${{ steps.visual-regression.outputs.visual_tests_passed || 'N/A' }}';
            const visualTestsFailed = '${{ steps.visual-regression.outputs.visual_tests_failed || 'N/A' }}';

            const componentsList = changedComponents.split(', ').map(c => '- `' + c + '`').join('\n');
            const screenshotsList = affectedScreenshots.split(', ').map(s => '- `' + s + '`').join('\n');

            const visualStatus = visualRegressionsDetected === 'true'
              ? 'âš ï¸ **Visual differences detected** - Review the visual regression report in the workflow artifacts'
              : visualRegressionsDetected === 'false'
              ? 'âœ… **No visual regressions detected**'
              : 'â“ **Visual regression status unknown**';

            const body = '## ğŸ“¸ Screenshots Auto-Updated\n\n' +
                    'âœ… **This PR has been automatically updated with regenerated screenshots**\n\n' +
                    '### ğŸ“Š Summary\n' +
                    '- **Components Changed:** ' + componentCount + '\n' +
                    '- **Screenshots Updated:** ' + screenshotCount + '\n\n' +
                    '### ğŸ§© Changed Components\n' +
                    componentsList + '\n\n' +
                    '### ğŸ“¸ Updated Screenshots\n' +
                    screenshotsList + '\n\n' +
                    '### ğŸ‘ï¸ Visual Regression Status\n' +
                    visualStatus + '\n\n' +
                    '- Tests Passed: ' + visualTestsPassed + '\n' +
                    '- Tests Failed: ' + visualTestsFailed + '\n\n' +
                    (visualRegressionsDetected === 'true' ? '**Note:** Visual differences may be intentional if the component UI was deliberately changed. Review the diff report in the workflow artifacts.\n\n' : '') +
                    '### âœ… Action Required\n' +
                    '- [ ] Review the auto-updated screenshots in this PR\n' +
                    '- [ ] Verify screenshots accurately represent the current UX\n' +
                    '- [ ] Update user guide text if component behavior changed\n\n' +
                    '---\n' +
                    'ğŸ¤– Auto-generated by Documentation Auto-Update workflow';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Upload Screenshot Artifacts
        if: always() && hashFiles('resources/user-guide/docs/images/screenshots/**') != ''
        uses: actions/upload-artifact@v4
        with:
          name: regenerated-screenshots
          path: resources/user-guide/docs/images/screenshots/
          retention-days: 30
