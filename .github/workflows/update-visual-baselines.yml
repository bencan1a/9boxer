name: Update Visual Regression Baselines

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for baseline update (e.g., "New button styling", "Updated theme colors")'
        required: false
        type: string
        default: 'Visual baseline update'
      multi_os:
        description: 'Update baselines on all OSes (Windows, macOS, Linux)'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      reason:
        description: 'Reason for baseline update'
        required: false
        type: string
        default: 'Visual baseline update (triggered automatically)'
      branch:
        description: 'Branch to update baselines on'
        required: false
        type: string
        default: 'main'
      multi_os:
        description: 'Update baselines on all OSes'
        required: false
        type: boolean
        default: false
  schedule:
    # Run every Sunday at 2 AM UTC (weekly comprehensive baseline check)
    - cron: '0 2 * * 0'

jobs:
  # Matrix strategy for all OS baselines
  update-baselines:
    name: Update Visual Baselines (${{ matrix.os-name }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 20
    permissions:
      contents: write

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            os-name: Linux
            runner: ubuntu-latest
          - os: windows
            os-name: Windows
            runner: windows-latest
          - os: macos
            os-name: macOS
            runner: macos-latest

    steps:
      # Skip non-Linux jobs unless multi_os is enabled or scheduled
      - name: Check if job should run
        id: should_run
        run: |
          if [[ "${{ matrix.os }}" == "linux" ]] || [[ "${{ inputs.multi_os }}" == "true" ]] || [[ "${{ github.event_name }}" == "schedule" ]]; then
            echo "run=true" >> $GITHUB_OUTPUT
          else
            echo "run=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Checkout code
        if: steps.should_run.outputs.run == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch || github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Python environment
        if: steps.should_run.outputs.run == 'true'
        uses: ./.github/actions/setup-python-env

      - name: Setup frontend environment
        if: steps.should_run.outputs.run == 'true'
        uses: ./.github/actions/setup-frontend-env
        with:
          skip-playwright-install: 'false'
          playwright-browsers: 'chromium'

      - name: Update and commit baselines
        if: steps.should_run.outputs.run == 'true'
        uses: ./.github/actions/update-visual-baselines
        with:
          os-name: ${{ matrix.os-name }}
          reason: ${{ github.event.inputs.reason || inputs.reason }}
          actor: ${{ github.actor }}
          run-id: ${{ github.run_id }}
          server-url: ${{ github.server_url }}
          repository: ${{ github.repository }}
