name: Documentation

on:
  push:
    branches:
      - main
    paths:
      - 'backend/src/**'
      - 'internal-docs/**'
      - 'agent-projects/**'
      - 'tools/build_context.py'
      - '.github/workflows/docs.yml'
  schedule:
    # Run weekly on Monday at 2 AM UTC
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      force-rebuild:
        description: 'Force rebuild all documentation'
        required: false
        default: false
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CONTEXT_MAX_CHARS: "150000"
  PLANS_MAX_AGE_DAYS: "21"
  CLEAN_TMP_AGE_DAYS: "7"

permissions:
  contents: write

jobs:
  build-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git SHA

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'

      - name: Cache uv packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            ~/AppData/Local/uv/cache
          key: uv-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Cache documentation build
        uses: actions/cache@v4
        with:
          path: |
            internal-docs/_generated/
            internal-docs/_build/
          key: docs-${{ runner.os }}-${{ hashFiles('backend/src/**/*.py', 'internal-docs/**/*.md', 'tools/build_context.py') }}
          restore-keys: |
            docs-${{ runner.os }}-

      - name: Install dependencies
        run: |
          pip install uv
          uv pip install --system pdoc3 sphinx sphinx-rtd-theme
          # Install project dependencies if needed for API doc generation
          if [ -f pyproject.toml ]; then
            uv pip install --system -e .
          fi

      - name: Build documentation
        run: |
          python tools/build_context.py

      - name: Check for changes
        id: check_changes
        run: |
          git diff --quiet internal-docs/ || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Validate generated files
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          # Check if critical files were generated
          if [ ! -f internal-docs/CONTEXT.md ]; then
            echo "Error: CONTEXT.md not generated"
            exit 1
          fi

          # Check file size isn't too large
          CONTEXT_SIZE=$(wc -c < internal-docs/CONTEXT.md)
          if [ "$CONTEXT_SIZE" -gt "$CONTEXT_MAX_CHARS" ]; then
            echo "Warning: CONTEXT.md is larger than ${CONTEXT_MAX_CHARS} characters (${CONTEXT_SIZE})"
          fi

      - name: Commit and push if changed
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add internal-docs/
          git commit -m "chore: auto-update documentation [skip ci]"
          git push

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: |
            internal-docs/
            !internal-docs/.git
          retention-days: 30

      - name: Summary
        run: |
          echo "### Documentation Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check_changes.outputs.changed }}" = "true" ]; then
            echo "ðŸ“ Documentation updated" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… Documentation up to date" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f internal-docs/CONTEXT.md ]; then
            CONTEXT_SIZE=$(wc -c < internal-docs/CONTEXT.md)
            echo "âœ… CONTEXT.md generated (${CONTEXT_SIZE} bytes)" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -f internal-docs/_generated/plans_index.md ]; then
            PLAN_COUNT=$(grep -c "^## " internal-docs/_generated/plans_index.md || echo "0")
            echo "ðŸ“‹ Active plans: ${PLAN_COUNT}" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -d internal-docs/_generated/api ]; then
            API_COUNT=$(find internal-docs/_generated/api -name "*.html" -o -name "*.md" | wc -l)
            echo "ðŸ“š API docs generated: ${API_COUNT} files" >> $GITHUB_STEP_SUMMARY
          fi

  internal-docs-maintenance:
    name: Weekly Internal Docs Maintenance
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git log

      - name: Get last run timestamp
        id: last-run
        run: |
          if [ -f .github/.internal-docs-maintenance-marker ]; then
            LAST_RUN=$(cat .github/.internal-docs-maintenance-marker)
            echo "timestamp=$LAST_RUN" >> $GITHUB_OUTPUT
            echo "date=$(date -d @$LAST_RUN '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

            # Calculate days since last run
            NOW=$(date +%s)
            DAYS=$(( ($NOW - $LAST_RUN) / 86400 ))
            echo "days=$DAYS" >> $GITHUB_OUTPUT
          else
            # First run - set to 7 days ago
            LAST_RUN=$(date -d '7 days ago' +%s)
            echo "timestamp=$LAST_RUN" >> $GITHUB_OUTPUT
            echo "date=$(date -d @$LAST_RUN '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
            echo "days=7" >> $GITHUB_OUTPUT
          fi

      - name: Get changed files since last run
        id: changed-files
        run: |
          SINCE_DATE=$(date -d @${{ steps.last-run.outputs.timestamp }} '+%Y-%m-%d %H:%M:%S')

          # Get changed .md files in internal-docs/
          CHANGED_FILES=$(git log --since="$SINCE_DATE" --name-only --pretty=format: -- internal-docs/ | grep '\.md$' | sort -u || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No internal documentation files changed since last run"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changed files:"
            echo "$CHANGED_FILES"
            echo "has_changes=true" >> $GITHUB_OUTPUT

            # Save to file for issue body
            echo "$CHANGED_FILES" > /tmp/changed-files.txt
          fi

      - name: Create maintenance issue
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changedFiles = fs.readFileSync('/tmp/changed-files.txt', 'utf8').trim();
            const lastRunDate = '${{ steps.last-run.outputs.date }}';
            const daysSinceLastRun = '${{ steps.last-run.outputs.days }}';

            const issueBody = `## Internal Documentation Maintenance Required

            **Last Run**: ${lastRunDate}
            **Days Since Last Run**: ${daysSinceLastRun}

            ### Files Changed Since Last Run

            \`\`\`
            ${changedFiles}
            \`\`\`

            ### Agent Task

            Please follow the agent task template to perform weekly documentation maintenance:

            ðŸ“‹ **Task Template**: [.github/agent-tasks/internal-docs-maintenance.md](.github/agent-tasks/internal-docs-maintenance.md)

            **Instructions**:
            1. Review changed files above
            2. Follow task template steps:
               - Inventory new documentation
               - Detect duplications
               - Consolidate into canonical sources
               - Archive superseded docs
               - Update auto-generated docs
               - Generate maintenance report
            3. Create PR with changes
            4. Update marker file with current timestamp

            ### Related

            - **Guide**: [agent-projects/internal-docs-consolidation/GUIDE.md](agent-projects/internal-docs-consolidation/GUIDE.md)
            - **Project**: Internal Documentation Consolidation (Issues #63-69)
            - **Milestone**: [Phase 3](https://github.com/bencan1a/9boxer/milestone/3)

            ### Success Criteria

            - [ ] All duplications detected and consolidated
            - [ ] Superseded docs archived with dates
            - [ ] build_context.py runs successfully
            - [ ] All links work (no broken references)
            - [ ] Pre-commit hooks pass
            - [ ] Marker file updated with current timestamp

            ---

            *Auto-generated by weekly internal docs maintenance workflow*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Internal Documentation Maintenance Required',
              body: issueBody,
              labels: ['documentation', 'maintenance', 'automated']
            });

      - name: Update last run marker
        if: always()
        run: |
          echo $(date +%s) > .github/.internal-docs-maintenance-marker
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .github/.internal-docs-maintenance-marker
          git commit -m "chore: Update internal docs maintenance marker [skip ci]" || echo "No changes to commit"
          git push || echo "Nothing to push"
