name: PR Documentation Check

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'frontend/src/**'
      - 'backend/src/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  check-docs:
    name: Check for New User-Facing Features
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate diff

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Detect New Features
        id: detect
        run: |
          node .github/scripts/detect-new-features.js --base=${{ github.base_ref }}

      - name: Comment on PR - Features Detected
        if: steps.detect.outputs.new_features_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const features = JSON.parse('${{ steps.detect.outputs.features }}');
            const featureCount = '${{ steps.detect.outputs.feature_count }}';

            // Group features by category
            const byCategory = features.reduce((acc, feature) => {
              const category = feature.category || 'Other';
              if (!acc[category]) acc[category] = [];
              acc[category].push(feature);
              return acc;
            }, {});

            // Build feature list
            let featureList = '';
            for (const [category, items] of Object.entries(byCategory)) {
              featureList += `\n#### ${category}\n\n`;
              items.forEach(item => {
                featureList += `- **${item.name}**`;
                if (item.details) {
                  featureList += ` - ${item.details}`;
                }
                if (item.component) {
                  featureList += ` (in \`${item.component}\`)`;
                }
                featureList += '\n';
              });
            }

            const body = '## ðŸ“¸ Documentation Reminder\n\n' +
                    'This PR adds **' + featureCount + '** new user-facing feature(s) that may need documentation:\n\n' +
                    featureList + '\n\n' +
                    '### âœ… Documentation Checklist\n\n' +
                    'Please ensure the following are updated as needed:\n\n' +
                    '- [ ] **User Guide** - Add feature description to relevant sections\n' +
                    '- [ ] **Screenshots** - Generate screenshots for new UI elements\n' +
                    '- [ ] **Example Workflows** - Add usage examples if applicable\n' +
                    '- [ ] **API Documentation** - Update if new endpoints/models added (backend)\n\n' +
                    '### ðŸ”§ Useful Commands\n\n' +
                    '```bash\n' +
                    '# Generate screenshots for documentation\n' +
                    'cd frontend\n' +
                    'npm run screenshots:generate\n\n' +
                    '# Preview user guide locally\n' +
                    'npm run docs:preview\n' +
                    '```\n\n' +
                    '### ðŸ“š Documentation Resources\n\n' +
                    '- [Screenshot Generation Guide](frontend/playwright/screenshots/README.md)\n' +
                    '- [User Guide Source](resources/user-guide/docs/)\n' +
                    '- [Design System Guidelines](DESIGN_SYSTEM.md)\n\n' +
                    '### â„¹ï¸ Note\n\n' +
                    'This is an automated reminder. If these features don\'t require user documentation (e.g., internal refactoring, backend-only changes), you can safely ignore this message.\n\n' +
                    '---\n\n' +
                    '*ðŸ¤– Auto-generated by PR Documentation Check workflow*';

            // Check if we already commented on this PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ“¸ Documentation Reminder')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Comment on PR - No Features Detected
        if: steps.detect.outputs.new_features_detected != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if we previously commented on this PR
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ“¸ Documentation Reminder')
            );

            // If we previously commented but now there are no features, remove the comment
            if (botComment) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
              });
            }

      - name: Upload Detection Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: new-features-detection
          path: .new-features.json
          retention-days: 30
