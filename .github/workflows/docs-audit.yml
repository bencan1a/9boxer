name: AI Documentation Audit

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      days:
        description: 'Number of days to look back for changes'
        required: false
        default: '7'
      dry_run:
        description: 'Dry run (do not create issues)'
        required: false
        type: boolean
        default: false
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM UTC

permissions:
  contents: read
  issues: write  # Required for creating GitHub issues

jobs:
  audit-docs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for git log analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: |
          cd .github/scripts
          npm install --no-save @anthropic-ai/sdk

      - name: Run AI documentation audit
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DAYS="${{ github.event.inputs.days || '7' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"

          if [ "$DRY_RUN" = "true" ]; then
            node .github/scripts/ai-docs-audit.js --days=$DAYS --dry-run
          else
            node .github/scripts/ai-docs-audit.js --days=$DAYS
          fi

      - name: Upload audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docs-audit-report
          path: docs-audit-report.json
          retention-days: 30

      - name: Post summary comment
        if: always() && !github.event.inputs.dry_run
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read audit report
            let report;
            try {
              const reportContent = fs.readFileSync('docs-audit-report.json', 'utf-8');
              report = JSON.parse(reportContent);
            } catch (error) {
              console.log('No audit report found or failed to parse');
              return;
            }

            // Validate report has required structure
            if (!report || !report.summary || !report.metadata) {
              console.log('Audit report is missing required fields (summary or metadata)');
              console.log('Report contents:', JSON.stringify(report, null, 2));
              return;
            }

            // Provide defaults for optional nested fields
            const summary = report.summary || {};
            const metadata = report.metadata || {};
            const issues = report.issues || [];
            const changes = report.changes || { stats: {} };
            const documentation = report.documentation || {};

            // Build summary comment
            const summaryComment = `## ðŸ¤– AI Documentation Audit Summary

            **Audit Period:** Last ${metadata.daysScanned || 'N/A'} days
            **Generated:** ${metadata.generatedAt ? new Date(metadata.generatedAt).toLocaleString() : 'N/A'}

            ### ðŸ“Š Results
            - **Total Issues Found:** ${summary.totalIssues || 0}
            - **GitHub Issues Created:** ${issues.length}

            ### ðŸ“‹ By Type
            ${summary.byType ? Object.entries(summary.byType)
              .filter(([_, count]) => count > 0)
              .map(([type, count]) => `- ${type}: ${count}`)
              .join('\n') : 'No issues by type'}

            ### ðŸš¨ By Severity
            ${summary.bySeverity ? Object.entries(summary.bySeverity)
              .filter(([_, count]) => count > 0)
              .map(([severity, count]) => {
                const icon = severity === 'high' ? 'ðŸ”´' : severity === 'medium' ? 'ðŸŸ¡' : 'ðŸŸ¢';
                return `${icon} **${severity}:** ${count}`;
              })
              .join('\n') : 'No issues by severity'}

            ${issues.length > 0 ? `
            ### ðŸŽ« Issues Created
            ${issues.slice(0, 10).map(issue => `- #${issue.number}: ${issue.title}`).join('\n')}
            ${issues.length > 10 ? `\n...and ${issues.length - 10} more` : ''}
            ` : ''}

            ### ðŸ“ˆ Code Activity
            - Commits analyzed: ${changes.stats?.totalCommits || 0}
            - Files changed: ${changes.stats?.totalFiles || 0}
            - Documentation files: ${documentation.totalFiles || 0}

            ---
            *View the [full audit report](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) in the workflow artifacts.*`;

            // Create a discussion or issue comment (if running on a PR)
            // For scheduled runs, we'll just log it
            console.log(summaryComment);

            // Optionally, you could create a GitHub Discussion or post to Slack/Discord here
