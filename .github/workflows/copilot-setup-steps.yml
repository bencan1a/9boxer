name: "Copilot Setup Steps"

# This workflow is used by GitHub Copilot's coding agent to set up the environment
# See: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # Python Backend Setup
      # ========================================
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
          cache: 'pip'
      
      - name: Create Python virtual environment
        run: |
          python3 -m venv .venv
          echo "Virtual environment created at .venv/"
      
      - name: Activate virtual environment and install dependencies
        run: |
          source .venv/bin/activate
          python -m pip install --upgrade pip
          pip install uv
          uv pip install --system -e '.[dev]'
          echo "Python dependencies installed"
      
      - name: Verify Python installation
        run: |
          source .venv/bin/activate
          python --version
          pip list | head -20
          which python
      
      # ========================================
      # Node.js Frontend Setup
      # ========================================
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        working-directory: frontend
        run: |
          npm ci
          echo "Frontend dependencies installed"
      
      - name: Verify Node.js installation
        working-directory: frontend
        run: |
          node --version
          npm --version
      
      # ========================================
      # Pre-commit hooks setup
      # ========================================
      
      - name: Install pre-commit hooks
        run: |
          source .venv/bin/activate
          pre-commit install
          echo "Pre-commit hooks installed"
      
      # ========================================
      # Environment validation
      # ========================================
      
      - name: Validate environment setup
        run: |
          echo "=== Environment Setup Complete ==="
          echo "Python virtual environment: $(ls -d .venv 2>/dev/null && echo '✓' || echo '✗')"
          echo "Frontend node_modules: $(ls -d frontend/node_modules 2>/dev/null && echo '✓' || echo '✗')"
          echo ""
          source .venv/bin/activate
          echo "Python version: $(python --version)"
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo ""
          echo "Key Python packages:"
          pip list | grep -E "fastapi|pytest|ruff|mypy" || echo "No key packages found"
          echo ""
          echo "Environment is ready for GitHub Copilot coding agent!"
