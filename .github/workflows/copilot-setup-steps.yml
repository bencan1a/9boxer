name: "Copilot Setup Steps"

# This workflow is used by GitHub Copilot's coding agent to set up the environment
# See: https://docs.github.com/en/copilot/how-tos/use-copilot-agents/coding-agent/customize-the-agent-environment

on:
  workflow_dispatch:  # Allow manual triggering
  push:
    paths:
      - ".github/workflows/copilot-setup-steps.yml"
    branches:
      - main
  pull_request:
    paths:
      - ".github/workflows/copilot-setup-steps.yml"

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    permissions:
      contents: read  # Required for actions/checkout

    steps:
      # ========================================
      # Repository Checkout
      # ========================================

      - name: Checkout repository
        uses: actions/checkout@v4
      # ========================================
      # Python Backend Setup
      # ========================================

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Install uv
        run: pip install uv

      - name: Install Python dependencies
        run: |
          uv pip install --system -e '.[dev]'
          echo "Python dependencies installed"

      - name: Verify Python installation
        run: |
          python --version
          pip list | head -20
          which python
          echo "Verifying pre-commit is installed..."
          pre-commit --version || (echo "ERROR: pre-commit not installed" && exit 1)

      # ========================================
      # Node.js Frontend Setup
      # ========================================

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: |
          npm ci
          echo "Frontend dependencies installed"

      - name: Verify Node.js installation
        working-directory: frontend
        run: |
          node --version
          npm --version

      # ========================================
      # Playwright Setup (for E2E tests)
      # ========================================

      - name: Cache Playwright browsers
        id: playwright-cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: frontend
        run: |
          npx playwright install --with-deps chromium
          echo "Playwright browsers installed"

      - name: Verify Playwright installation
        working-directory: frontend
        run: |
          npx playwright --version

      # ========================================
      # Pre-commit hooks setup
      # ========================================

      - name: Install pre-commit hooks
        run: |
          pre-commit install
          echo "Pre-commit hooks installed"

      # ========================================
      # Environment validation
      # ========================================

      - name: Validate environment setup
        run: |
          echo "=== Environment Setup Complete ==="
          echo "Frontend node_modules: $(ls -d frontend/node_modules 2>/dev/null && echo '✓' || echo '✗')"

          # Check Playwright browsers (Linux path)
          if [ -d ~/.cache/ms-playwright ]; then
            echo "Playwright browsers: ✓"
          else
            echo "Playwright browsers: ✗"
          fi

          echo ""
          echo "Python version: $(python --version)"
          echo "Node.js version: $(node --version)"
          echo "npm version: $(npm --version)"
          echo ""
          echo "Key Python packages:"
          pip list | grep -E "fastapi|pytest|ruff|mypy|pre-commit" || echo "No key packages found"
          echo ""
          echo "Playwright version:"
          cd frontend && npx playwright --version
          echo ""
          echo "Pre-commit hooks:"
          pre-commit --version
          echo ""
          echo "Environment is ready for GitHub Copilot coding agent!"
