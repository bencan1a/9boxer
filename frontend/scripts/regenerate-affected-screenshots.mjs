#!/usr/bin/env node
/**
 * Regenerate affected screenshots based on change detection
 *
 * This script reads the .affected-screenshots.json file generated by
 * detect-doc-impact.js and selectively regenerates only the screenshots
 * that were affected by code changes.
 *
 * Usage:
 *   node frontend/scripts/regenerate-affected-screenshots.mjs [--dry-run]
 *
 * Options:
 *   --dry-run  Show what would be regenerated without actually doing it
 */

import { execSync } from "child_process";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const PROJECT_ROOT = path.resolve(__dirname, "../..");

/**
 * Load affected screenshots data
 *
 * @returns {Object} Affected screenshots data
 */
function loadAffectedScreenshots() {
  const dataPath = path.join(PROJECT_ROOT, ".affected-screenshots.json");

  if (!fs.existsSync(dataPath)) {
    console.error("‚ùå .affected-screenshots.json not found!");
    console.error("   Run: node .github/scripts/detect-doc-impact.js");
    process.exit(1);
  }

  try {
    const content = fs.readFileSync(dataPath, "utf-8");
    return JSON.parse(content);
  } catch (error) {
    console.error(
      "‚ùå Failed to load .affected-screenshots.json:",
      error.message
    );
    process.exit(1);
  }
}

/**
 * Regenerate a single screenshot
 *
 * @param {string} screenshotId - Screenshot ID to regenerate
 * @param {boolean} dryRun - If true, don't actually regenerate
 * @returns {boolean} Success status
 */
function regenerateScreenshot(screenshotId, dryRun = false) {
  if (dryRun) {
    console.log(`   [DRY RUN] Would regenerate: ${screenshotId}`);
    return true;
  }

  try {
    console.log(`   üîÑ Regenerating: ${screenshotId}`);

    execSync(`npm run screenshots:generate ${screenshotId}`, {
      cwd: path.join(PROJECT_ROOT, "frontend"),
      stdio: "inherit", // Show output in real-time for better debugging
      encoding: "utf-8",
    });

    console.log(`   ‚úÖ Success: ${screenshotId}`);
    return true;
  } catch (error) {
    console.error(`   ‚ùå Failed: ${screenshotId}`);
    console.error(`      Error: ${error.message}`);

    // Check if screenshot exists in config
    if (
      error.message.includes("not found") ||
      error.message.includes("No workflow")
    ) {
      console.error(`      Screenshot may not exist in config.ts`);
    }

    return false;
  }
}

/**
 * Main function
 */
function main() {
  console.log("üì∏ Regenerating affected documentation screenshots...\n");

  // Check for dry-run flag
  const dryRun = process.argv.includes("--dry-run");
  if (dryRun) {
    console.log(
      "üèÉ DRY RUN MODE - No screenshots will be actually regenerated\n"
    );
  }

  // Load affected screenshots data
  const data = loadAffectedScreenshots();

  console.log("üìä Analysis Summary:");
  console.log(`   Components changed: ${data.metadata.totalComponents}`);
  console.log(`   Screenshots affected: ${data.metadata.totalScreenshots}`);
  console.log(
    `   Generated at: ${new Date(data.metadata.generatedAt).toLocaleString()}`
  );

  if (data.metadata.themeChanged) {
    console.log(`   ‚ö†Ô∏è  Theme changed: Consider regenerating ALL screenshots`);
  }

  console.log();

  if (data.screenshots.length === 0) {
    console.log("‚úÖ No screenshots to regenerate");
    process.exit(0);
  }

  console.log(`üì∏ Regenerating ${data.screenshots.length} screenshot(s):\n`);

  // Track results
  const results = {
    total: data.screenshots.length,
    success: 0,
    failed: 0,
    failedScreenshots: [],
  };

  // Regenerate each screenshot
  for (let i = 0; i < data.screenshots.length; i++) {
    const screenshotId = data.screenshots[i];
    console.log(`\n[${i + 1}/${data.screenshots.length}] ${screenshotId}`);

    const success = regenerateScreenshot(screenshotId, dryRun);

    if (success) {
      results.success++;
    } else {
      results.failed++;
      results.failedScreenshots.push(screenshotId);
    }
  }

  // Print summary
  console.log("\n" + "‚îÄ".repeat(60));
  console.log("üìä Regeneration Summary");
  console.log("‚îÄ".repeat(60));
  console.log(`Total: ${results.total}`);
  console.log(`‚úÖ Success: ${results.success}`);
  console.log(`‚ùå Failed: ${results.failed}`);

  if (results.failed > 0) {
    console.log("\n‚ùå Failed screenshots:");
    results.failedScreenshots.forEach((id) => {
      console.log(`   - ${id}`);
    });
  }

  console.log("‚îÄ".repeat(60));

  // Exit with appropriate code
  if (dryRun) {
    console.log("\n‚úÖ Dry run completed successfully");
    process.exit(0);
  } else if (results.failed > 0) {
    console.log("\n‚ö†Ô∏è  Some screenshots failed to regenerate");
    process.exit(1);
  } else {
    console.log("\n‚úÖ All screenshots regenerated successfully!");
    process.exit(0);
  }
}

// Only run if executed directly
if (import.meta.url === `file://${process.argv[1]}`) {
  main();
}
